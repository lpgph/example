# Spring oauth2 踩坑与实践
## 前言
### 不同的版本
### 继承与Bean注解
### 微服务体系下认证授权
## 认证与授权服务器
### 认证与授权
    认证授权服务是单独部署的 认证与授权是分离的 
    
    统一的授权服务 不同的微服务体系 不同的授权服务
    举例:
        A 系统有自己的一套会员体系
        B 系统有自己的一套会员体系
    这时就需要 共享认证 分别授权  每一套系统管理自己的授权服务  但都使用同一个授权服务 认证采取oidc(OpenId Connect) 授权采取oauth2
    认证不负责权限  授权单独管理系统内的权限！
    
    或者可以让第三方授权
    A 系统中用户 和B 系统中用户 是独立的
    但是可以通过授权的方式进行认证
    比如 A 系统下的会员A访问B系统，那么B系统在会员A授权后 建立第三方授权的B系统会员A 
    A 系统下分为商城  CMS ERP 等系统  这是在一个授权认证系统内
    B 系统下的 的商城 需要重新认证授权
    
    例如 微信系统 QQ系统
    游戏的话就通过这个两个系统的授权 生成自己的账号体系 
    一般绑定一个 可以绑定多个  即 一个游戏账户只能绑定一个微信或QQ,登录只能通过QQ或微信登录 
    也可设置同时绑定QQ和微信  这样两个就互通了
    
    该项目中 认证与授权是包含在一个服务去构建的（以下简称uaa） 如果存在多个微服务项目 且每个微服务项目之间授权不同不可以互相调用(JWT证书不同)  那么就需要拆分授权和认证了
    认证服务  用户的登录以及验证  一般的sso指的是这一部分 通过session管理状态
    授权服务  oauth2 生成jwt token  通过token去操作资源服务
    以上可以看到 uaa是认证通过后通过session取获取授权服务的token 然后通过token去操作资源
    而 uaa 中包含 用户(账号密码以及部分用户信息) 角色 资源(权限) 客户端(oauth2) 客户端范围域(oauth2) 这些资源 电商行业还会包含用户邀请关系
    uaa 是有单独的后台管理系统的 该系统是通过session管理状态 对以上资源进行操作的
    那么前端用户如何对个人的 账号密码 第三方授权凭证 以及部分个人信息(如头像，性别等用户资料) 进行管理?
    此时就需要创建一个资源服务对这些操作进行管理 同时为了方便 把 userinfo 端点 也放到该资源服务中
### 其他认证对接
    注意对接的是认证而非授权  在认证中对 第三方登录 手机验证码 验证后绑定用户  网上有些博文是通过添加oauth2的 grant_type 类型来解决的
    用户授权途径 一个是通过帐号密码以及客户端获取token (password) 另一个是认证通过后通过客户端以及授权码来获取token (authorization_code)
    并不建议使用 password 模式 如果非要使用 建议在uaa服务中认证成功后调用password生成token返回 而不是添加 grant_type 类型
    认证与授权是两个方面 不要混合到一起
    
### 服务端点
    userinfo 将用户的信息放入token中 userinfo端点负责提取token中的用户信息并返回(传统的方式是从缓存或数据库中读取的) 如昵称 头像 性别 手机 邮箱等信息
### 权限控制
    要素有 客户端 客户端范围域 客户端资源 角色(可继承) 角色权限(资源+操作) 用户 用户组(基本和角色重合 可以考虑不需要)
    客户端范围域考虑两种要素
    1. 客户端对资源服务器的请求  类似如 公共平台API  需要对客户端进行权限和接口的管控
    2. 客户端下用户对资源服务器的请求 如 管理平台客户端 和 商城客户端 需要对用户权限进行进一步限制
    客户端范围域 > 用户角色 > 资源权限
    客户端范围域做为一级过滤  资源权限为具体请求
    角色根据需求 如果角色简单(比如就 admin staff user) 那么角色可以做为一级过滤
    而往往企业角色会分的很细致  如果staff 分为客服 客服主管 运营 运营主管 等等 存在复合/继承关系 这时候就不可以做为一级过滤了
    
    客户端 创建资源 资源分配scope 角色分配资源  用户分配角色  用户组分配角色
    1. 资源 scope是多对多关系 且可选 具体需要看资源服务器是怎么设置的 看权限的粒细度
    
    如 /user 限制了客户端访问 scope 就做为一级过滤
    但是scope的继承关系如何处理？
    如 order order:read order:write 前者包含后两个 那就是配置 SecurityConfig 的时候添加多个scope 
    keycloak 的权限配置可以做为参考  具体应用根据实际情况设计
    ========
    角色层次 ROLE_ADMIN > ROLE_STAFF > ROLE_USER > ROLE_GUEST
    用户组非必须 考虑后续默认权限管理根据需求设计  管理员(默认admin)  员工(默认)  用户  组设置默认权限 
    角色基本上就包含了组的概念
### 用户管理
    授权服务中只保留用户帐号密码以及第三方平台认证信息 用户权限信息 客户端信息
    用户的详情等信息在其他资源服务中处理 不应该放到认证服务中
    用户操作只有 修改账户和密码  绑定和解绑第三方认证
 
    管理员会划分 系统管理员 运营 客服等角色
    用户还会划分 买家 卖家/商家 开发者 等角色
    根据业务需求 
    如果管理员和用户使用独立的账户  那么需要分开两个认证授权端 而且用户的卖家 开发者也需要接口权限的划分 
    后续还需要考虑各个角色之间如何打通 而且项目配置中也需要根据接口划分多个安全配置比较麻烦
    相比之下建议使用一张表管理用户的帐号密码信息 其他信息通过关联表的形式 如 account 管理用户账户密码 account_role 划分角色 user_info 用户详情 admin_info 管理员详情 等等
    管理员和用户之间的接口通过客户端范围域划分 管理平台客户端在保留在内网中 外网需要访问通过代理的形式来访问
    如果使用不同的登录页 
        1. 重写登录页请求 根据IP返回不同的登录页面
        2. 客户端再转发到登录页时先进行一次客户端认证  客户端认证后根据携带token或cookie请求登录
        认证授权服务器识别客户端跳转到不同登录页
    如何限制跨域
        如果前台系统后台系统之间不需要设置SSO 如CMS系统和商城系统  CMS跳转到商城系统时需要重新认证
          
    =============
    思考 管理员和用户账户密码使用同一张表情况时 一些电商行业有特别的需求 如用户邀请注册
    那么这个注册功能就不能放到认证服务器了 在网关或者用户资源中进行处理 验证邀请码后 通过远程调用认证服务器注册服务 返回用户id 然后创建用户邀请码等信息 
        
## 通过token授权的资源服务器
### 接口的划分
    公共API 服务间API 授权API
### 客户端范围与用户权限
### 自定义用户权限认证管理
#### web
#### webFlux
### 调用其他资源服务器资源
## 网关与客户端
### 浏览器端网关
#### 认证状态的刷新(session与cookie)
### 手机端的网关
#### 认证状态的刷新(access_token与refresh_token)
#### 如何获取认证token与刷新token
### API平台的网关
#### 认证状态的刷新(access_token与refresh_token)
    client_credentials  client-id,client-secret 
### 参考
   [Keycloak Documentation](https://www.keycloak.org/documentation.html)
   [Keycloak Docker](https://github.com/keycloak/keycloak-containers/blob/11.0.3/server/README.md)
   [Who](https://github.com/guevara/read-it-later/issues/6756)
   [oauth2](https://tools.ietf.org/html/rfc6749)
   [微服务下权限设计](http://seanthefish.com/2020/07/24/micro-service-authorization/index.html)  